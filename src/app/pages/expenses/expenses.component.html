<div class="expenses-page">
  
  <div class="page-header">
    <div class="header-content">
      <h2>Expenses Management</h2>
      <div class="header-actions">
        <button class="btn btn-export" (click)="exportToExcel()" [disabled]="expenses.length === 0">
          üìä Export to Excel
        </button>
        <button class="btn btn-primary" (click)="showAddExpenseForm()">
          + Add New Expense
        </button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Expense Modal -->
  @if (showAddForm) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ editingExpense ? 'Edit Expense' : 'Add New Expense' }}</h2>
          <button class="close-btn" (click)="closeModal()">&times;</button>
        </div>
        
        <div class="modal-body">
          <form (ngSubmit)="saveExpense()" #expenseForm="ngForm">
            <!-- Basic Information Section -->
            <div class="form-section">
              <!-- //<h4 style="margin-bottom: 16px; color: #374151;">Basic Information</h4> -->
              <div class="form-row">
                <div class="form-group">
                  <label for="title">Title *</label>
                  <input 
                    type="text" 
                    id="title"
                    [(ngModel)]="formTitle" 
                    name="title" 
                    class="form-control"
                    placeholder="Enter expense title"
                    required>
                </div>

                <div class="form-group">
                  <label for="category">Category *</label>
                  <select 
                    id="category"
                    [(ngModel)]="formCategory" 
                    name="category" 
                    class="form-control"
                    required>
                    <option value="">Select Category</option>
                    @for (cat of categories; track cat) {
                      <option [value]="cat">{{ cat }}</option>
                    }
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label for="description">Description</label>
                <textarea 
                  id="description"
                  [(ngModel)]="formDescription" 
                  name="description" 
                  class="form-control"
                  placeholder="Optional description"
                  rows="3">
                </textarea>
              </div>
            </div>

            <!-- Financial Information Section -->
            <div class="form-section">
              <h4 style="margin-bottom: 16px; color: #374151;">Financial Details</h4>
              <div class="form-row">
                <div class="form-group">
                  <label for="amount">Amount (‚Çπ) *</label>
                  <input 
                    type="number" 
                    id="amount"
                    [(ngModel)]="formAmount" 
                    name="amount" 
                    class="form-control"
                    min="0"
                    step="0.01"
                    placeholder="0.00"
                    required>
                </div>

                <div class="form-group">
                  <label for="type">Type *</label>
                  <select 
                    id="type"
                    [(ngModel)]="formType" 
                    name="type" 
                    class="form-control"
                    required>
                    <option value="">Select Type</option>
                    @for (type of expenseTypes; track type) {
                      <option [value]="type.value">{{ type.label }}</option>
                    }
                  </select>
                </div>
              </div>
            </div>

            <!-- Payment Method Section -->
            <div class="form-section">
              <h4 style="margin-bottom: 16px; color: #374151;">Payment Method</h4>
              <div class="form-group">
                <label for="paymentMode">Payment Mode *</label>
                <select 
                  id="paymentMode"
                  [(ngModel)]="formPaymentMode" 
                  name="paymentMode" 
                  class="form-control"
                  required
                  (change)="onPaymentModeChange()">
                  <option value="">Select Mode</option>
                  @for (mode of paymentModes; track mode.value) {
                    <option [value]="mode.value">{{ mode.label }}</option>
                  }
                </select>
              </div>

              <!-- Conditional Fields -->
              <div class="conditional-fields">
                @if (formPaymentMode === 'UPI') {
                  <div class="form-row conditional-field">
                    <div class="form-group">
                      <label for="upiProvider">UPI Provider *</label>
                      <select 
                        id="upiProvider"
                        [(ngModel)]="formUpiProvider" 
                        name="upiProvider" 
                        class="form-control"
                        required>
                        <option value="">Select UPI Provider</option>
                        @for (provider of upiProviders; track provider) {
                          <option [value]="provider">{{ provider }}</option>
                        }
                      </select>
                    </div>

                    <div class="form-group">
                      <label for="bank">Bank *</label>
                      <select 
                        id="bank"
                        [(ngModel)]="formBank" 
                        name="bank" 
                        class="form-control"
                        required>
                        <option value="">Select Bank</option>
                        @for (bank of banks; track bank) {
                          <option [value]="bank">{{ bank }}</option>
                        }
                      </select>
                    </div>
                  </div>
                }

                @if (formPaymentMode === 'Credit') {
                  <div class="form-group conditional-field">
                    <label for="creditBank">Bank *</label>
                    <select 
                      id="creditBank"
                      [(ngModel)]="formBank" 
                      name="creditBank" 
                      class="form-control"
                      required>
                      <option value="">Select Bank</option>
                      @for (bank of banks; track bank) {
                        <option [value]="bank">{{ bank }}</option>
                      }
                    </select>
                  </div>
                }
              </div>
            </div>

            <!-- Date Information Section -->
            <div class="form-section">
              <!-- <h4 style="margin-bottom: 16px; color: #374151;">Date Information</h4> -->
              <div class="form-group">
                <label for="date">Date *</label>
                <input 
                  type="date" 
                  id="date"
                  [(ngModel)]="formDate" 
                  name="date" 
                  class="form-control"
                  [value]="formDate || getTodayDate()"
                  required>
              </div>
            </div>

            <div class="form-actions">
              <button 
                type="button" 
                class="btn btn-secondary" 
                (click)="closeModal()">
                Cancel
              </button>
              <button 
                type="submit" 
                class="btn btn-primary" 
                [disabled]="!isFormValid()">
                {{ editingExpense ? 'Update' : 'Add' }} Expense
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  }

  <!-- Export Progress -->
  @if (isExporting) {
    <div class="export-progress">
      <div class="progress-content">
        <p>üì§ Preparing Excel file for download...</p>
        <div class="progress-bar">
          <div class="progress-fill"></div>
        </div>
      </div>
    </div>
  }

  <!-- Expenses Summary -->
  <div class="summary-cards">
    <div class="summary-card">
      <h4>Total Expenses</h4>
      <p class="amount">{{ formatNumber(getTotalExpenses()) }}</p>
      <small>All time expenses</small>
    </div>
    <div class="summary-card">
      <h4>Total Income</h4>
      <p class="amount income">{{ formatNumber(getTotalIncome()) }}</p>
      <small>All time income</small>
    </div>
    <div class="summary-card">
      <h4>Net Balance</h4>
      <p class="amount" [class.positive]="getBalance() >= 0" [class.negative]="getBalance() < 0">
        {{ formatNumber(getBalance()) }}
      </p>
      <small>{{ getBalance() >= 0 ? 'Surplus' : 'Deficit' }}</small>
    </div>
    <div class="summary-card">
      <h4>Total Records</h4>
      <p class="count">{{ filteredExpenses.length }}</p>
      <small>Filtered expenses</small>
    </div>
  </div>

  <!-- Expenses List -->
  <div class="expenses-list card">
    <div class="list-header">
      <h3>Expense History</h3>
      <div class="list-actions">
        <div class="filter-controls">
          <div class="filter-group">
            <label>Category:</label>
            <select [(ngModel)]="selectedCategory" (change)="applyFilters()" class="category-filter">
              <option value="">All Categories</option>
              @for (cat of categories; track cat) {
                <option [value]="cat">{{ cat }}</option>
              }
            </select>
          </div>
          <div class="filter-group">
            <label>Type:</label>
            <select [(ngModel)]="selectedType" (change)="applyFilters()" class="type-filter">
              <option value="">All Types</option>
              @for (type of expenseTypes; track type) {
                <option [value]="type.value">{{ type.label }}</option>
              }
            </select>
          </div>
          <div class="filter-group">
            <label>Payment Mode:</label>
            <select [(ngModel)]="selectedPaymentMode" (change)="applyFilters()" class="payment-mode-filter">
              <option value="">All Modes</option>
              @for (mode of paymentModes; track mode.value) {
                <option [value]="mode.value">{{ mode.label }}</option>
              }
            </select>
          </div>
          @if (selectedCategory || selectedType || selectedPaymentMode) {
            <button class="btn btn-clear-filter" (click)="clearFilters()">
              Clear Filters
            </button>
          }
        </div>
        <button class="btn btn-export-secondary" (click)="exportToExcel()" [disabled]="expenses.length === 0">
          üì• Export
        </button>
      </div>
    </div>
    
    @if (filteredExpenses.length === 0 && !isLoading) {
      <div class="empty-state">
        @if (selectedCategory || selectedType || selectedPaymentMode) {
          <div class="empty-icon">üîç</div>
          <p>No expenses found for the selected filters.</p>
          <button class="btn btn-secondary" (click)="clearFilters()">
            Clear Filters
          </button>
        } @else {
          <div class="empty-icon">üí∏</div>
          <p>No expenses found. Add your first expense!</p>
          <button class="btn btn-primary" (click)="showAddExpenseForm()">
            Add First Expense
          </button>
        }
      </div>
    }

    @if (isLoading) {
      <div class="empty-state">
        <div class="empty-icon">‚è≥</div>
        <p>Loading expenses...</p>
      </div>
    }

    @if (filteredExpenses.length > 0) {
      <div class="table-container">
        <table class="expenses-table">
          <thead>
            <tr>
              <th (click)="onSort('title')" [class]="getSortClass('title')">
                Title
                <span class="sort-indicator">{{ getSortIndicator('title') }}</span>
              </th>
              <th (click)="onSort('category')" [class]="getSortClass('category')">
                Category
                <span class="sort-indicator">{{ getSortIndicator('category') }}</span>
              </th>
              <th (click)="onSort('amount')" [class]="getSortClass('amount')">
                Amount
                <span class="sort-indicator">{{ getSortIndicator('amount') }}</span>
              </th>
              <th (click)="onSort('type')" [class]="getSortClass('type')">
                Type
                <span class="sort-indicator">{{ getSortIndicator('type') }}</span>
              </th>
              <th>Payment Mode</th>
              <th (click)="onSort('date')" [class]="getSortClass('date')">
                Date
                <span class="sort-indicator">{{ getSortIndicator('date') }}</span>
              </th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (expense of filteredExpenses; track expense.id + '-' + expense.date) {
              <tr>
                <td class="expense-title">
                  <strong>{{ expense.title }}</strong>
                  @if (expense.description) {
                    <small class="description">{{ expense.description }}</small>
                  }
                </td>
                <td>
                  <span class="category-badge">{{ expense.category }}</span>
                </td>
                <td class="amount" [class.income]="expense.type === 'income'">
                  ‚Çπ{{ getExpenseAmountFormatted(expense.amount) }}
                </td>
                <td>
                  <span [class]="'type type-' + expense.type.toLowerCase()">
                    {{ expense.type }}
                  </span>
                </td>
                <td>
                  <span [class]="'payment-mode payment-' + expense.paymentMode?.toLowerCase()">
                    {{ getPaymentModeDisplay(expense.paymentMode) }}
                  </span>
                  @if (expense.paymentMode === 'UPI' && expense.upiProvider) {
                    <small class="payment-detail">via {{ expense.upiProvider }}</small>
                  }
                  @if ((expense.paymentMode === 'UPI' || expense.paymentMode === 'Credit') && expense.bank) {
                    <small class="payment-detail">({{ expense.bank }})</small>
                  }
                </td>
                <td>{{ formatDisplayDate(expense.date) }}</td>
                <td class="actions">
                  <button class="btn-edit" (click)="editExpense(expense)">Edit</button>
                  <button class="btn-delete" (click)="confirmDeleteExpense(expense)">Delete</button>
                </td>
              </tr>
            }
          </tbody>
        </table>
        <div class="table-footer">
          <p>Showing {{ filteredExpenses.length }} of {{ expenses.length }} expenses ‚Ä¢ 
            <a href="javascript:void(0)" (click)="exportToExcel()" class="export-link">Export all data to Excel</a>
          </p>
        </div>
      </div>
    }
  </div>

  <!-- Delete Confirmation Modal -->
  @if (showDeleteModal) {
    <div class="modal-overlay" (click)="cancelDelete()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Confirm Deletion</h3>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete this expense? This action cannot be undone.</p>
          
          <div class="expense-details">
            <p>
              <strong>Title:</strong>
              <span>{{ expenseToDelete?.title }}</span>
            </p>
            <p>
              <strong>Amount:</strong>
              <span>‚Çπ{{ getExpenseAmountFormatted(expenseToDelete?.amount) }}</span>
            </p>
            <p>
              <strong>Category:</strong>
              <span>{{ expenseToDelete?.category }}</span>
            </p>
            <p>
              <strong>Type:</strong>
              <span>{{ expenseToDelete?.type }}</span>
            </p>
            <p>
              <strong>Payment Mode:</strong>
              <span>{{ getPaymentModeDisplay(expenseToDelete?.paymentMode) }}</span>
            </p>
            @if (expenseToDelete?.paymentMode === 'UPI' && expenseToDelete?.upiProvider) {
              <p>
                <strong>UPI Provider:</strong>
                <span>{{ expenseToDelete?.upiProvider }}</span>
              </p>
            }
            @if ((expenseToDelete?.paymentMode === 'UPI' || expenseToDelete?.paymentMode === 'Credit') && expenseToDelete?.bank) {
              <p>
                <strong>Bank:</strong>
                <span>{{ expenseToDelete?.bank }}</span>
              </p>
            }
            <p>
              <strong>Date:</strong>
              <span>{{ formatDisplayDate(expenseToDelete?.date) }}</span>
            </p>
            @if (expenseToDelete?.description) {
              <p>
                <strong>Description:</strong>
                <span>{{ expenseToDelete?.description }}</span>
              </p>
            }
          </div>
          
          <div class="warning-text">
            ‚ö†Ô∏è This action cannot be undone. The expense will be permanently deleted.
          </div>
        </div>
        <div class="modal-actions">
          <button 
            class="btn btn-secondary" 
            (click)="cancelDelete()" 
            [disabled]="isDeleting">
            Cancel
          </button>
          <button 
            class="btn btn-danger" 
            (click)="executeDelete()" 
            [disabled]="isDeleting">
            @if (isDeleting) {
              <span class="deleting-text">
                <span class="spinner"></span>
                Deleting...
              </span>
            } @else {
              Delete Expense
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>